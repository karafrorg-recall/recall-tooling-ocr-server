#!/usr/bin/env bash

###### script header ######

lib=$(realpath @@BASE_LIB@@) || exit 1
stat "${lib}" >> /dev/null || exit 1

# shellcheck source=../bazel/shell/lib.bash
if ! source "${lib}"; then
  echo "Error: could not find import"
  exit 1
fi

shfmt=$(realpath @@SHFMT@@)
stat "${shfmt}" >> /dev/null
shellcheck=$(realpath @@SHELLCHECK@@)
stat "${shellcheck}" >> /dev/null

# Guard workspace directory usage (avoid unbound variable on macOS)
if [[ -n ${BUILD_WORKSPACE_DIRECTORY:-} ]]; then
  cd "${BUILD_WORKSPACE_DIRECTORY}" || exit 1
fi

###### script body ######

# Collect scripts using a portable while-read loop (no readarray/mapfile)
declare -a scripts
while IFS= read -r line; do
  [[ -n ${line} ]] && scripts+=("${line}")
done < <(${shfmt} -f "${BUILD_WORKSPACE_DIRECTORY}")

# Explicitly declare arrays to avoid 'unbound variable' with set -u
declare -a excludeDirs=(
  ".direnv"
  "build"
)

# Initialize excludeFiles safely and iterate with default expansion to avoid 'unbound variable'
if [[ -z ${excludeFiles+x} ]]; then
  declare -a excludeFiles=()
fi

echo "The following scripts are excluded by their directory and won't be linted with shellcheck:"
for exclude in "${excludeDirs[@]}"; do
  for i in "${!scripts[@]}"; do
    if [[ ${scripts[i]} == "${BUILD_WORKSPACE_DIRECTORY}/${exclude}"* ]]; then
      printf "\t%s\n" "${scripts[i]}"
      unset 'scripts[i]'
    fi
  done
done

echo "The following scripts are excluded and won't be linted with shellcheck:"
for exclude in "${excludeFiles[@]-}"; do
  for i in "${!scripts[@]}"; do
    if [[ ${scripts[i]} == "${BUILD_WORKSPACE_DIRECTORY}/${exclude}" ]]; then
      printf "\t%s" "${scripts[i]}"
      unset 'scripts[i]'
    fi
  done
done

echo "Linting the following scripts with shellcheck:"
for script in "${scripts[@]}"; do
  printf "\t%s\n" "${script}"
done

statuscode=0
for file in "${scripts[@]}"; do
  "${shellcheck}" --severity=info "${file}" || statuscode=$?
done

exit "${statuscode}"
