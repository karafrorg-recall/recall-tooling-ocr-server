"""Build file for Leptonica library"""

load("@rules_cc//cc:defs.bzl", "cc_library")

genrule(
    name = "config_headers",
    outs = [
        "src/config_auto.h",
        "src/endianness.h",
    ],
    cmd = """
cat > $(location src/config_auto.h) << 'EOF'
/* config_auto.h - Generated by Bazel */
#ifndef LEPTONICA_CONFIG_AUTO_H
#define LEPTONICA_CONFIG_AUTO_H
#define LIBLEPT_MAJOR_VERSION 1
#define LIBLEPT_MINOR_VERSION 84
#define LIBLEPT_PATCH_VERSION 1
#define HAVE_STDINT_H 1
#endif
EOF

cat > $(location src/endianness.h) << 'EOF'
/* endianness.h - Generated by Bazel */
#ifndef LEPTONICA_ENDIANNESS_H
#define LEPTONICA_ENDIANNESS_H
#include <stdint.h>
#if defined(__BYTE_ORDER__) && defined(__ORDER_LITTLE_ENDIAN__) && (__BYTE_ORDER__ == __ORDER_LITTLE_ENDIAN__)
  #define L_LITTLE_ENDIAN 1
#elif defined(__LITTLE_ENDIAN__) || defined(_LITTLE_ENDIAN) || defined(__ARMEL__) || defined(__AARCH64EL__) || defined(_M_IX86) || defined(_M_X64) || defined(_M_ARM) || defined(_M_ARM64)
  #define L_LITTLE_ENDIAN 1
#else
  #define L_BIG_ENDIAN 1
#endif
#endif
EOF
""",
)

cc_library(
    name = "leptonica",
    srcs = glob(
        ["src/*.c"],
        exclude = [
            "src/*_reg.c",
            "src/xtractprotos.c",
        ],
    ) + [":config_headers"],
    hdrs = glob(["src/*.h"]) + [
        "src/config_auto.h",
        "src/endianness.h",
    ],
    copts = [
        "-w",
        "-DHAVE_CONFIG_H",
    ],
    includes = ["src"],
    textual_hdrs = [
        "src/allheaders.h",
        "src/alltypes.h",
    ],
    visibility = ["//visibility:public"],
)
